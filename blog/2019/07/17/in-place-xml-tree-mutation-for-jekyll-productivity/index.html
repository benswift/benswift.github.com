<!DOCTYPE html>
<html lang="en-AU">
  <head>
	<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#be2edd">
<link rel="stylesheet" type="text/css" href="/assets/css/normalize-9930e054e512c7aeb21cfc22c0816d7f701b97910a1bd67954c03be76c9f3e90.css">

<!-- fontawesome -->
<script defer src="https://use.fontawesome.com/releases/v5.6.3/js/all.js" integrity="sha384-EIHISlAOj4zgYieurP0SdoiBYfGJKkgWedPHH4jCzpCXLmzVsw1ouK59MuUtP4a1" crossorigin="anonymous"></script>

<!-- anchor.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.0/anchor.min.js" integrity="sha256-m1eTvwEHwmsw4+XKF7BshClVJEPwTVycveNl0CS0Mkk=" crossorigin="anonymous"></script>

<script>
 anchors.options = {
   visible: "touch",
   icon: "#"
 };
 document.addEventListener("DOMContentLoaded", function(event) {
   anchors.add("article > h2, article > h3");
 });
</script>


<!-- highlight.js -->
<script src="/assets/js/highlight.pack-cf914cddba9ab5aaea7819f239c3df41f840b83b1c8c54e37675236e6b2ed74c.js" type="text/javascript"></script>
<link rel="stylesheet" type="text/css" href="/assets/css/atom-one-dark-470b7658ef8aee2f2bb86babcc8a359491361d94113130f47878659a07f47eac.css">

<script>
 hljs.initHighlightingOnLoad();
</script>


<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>In-place XML tree mutation for Jekyll productivity | benswift.me</title>
<meta name="generator" content="Jekyll v3.8.6" />
<meta property="og:title" content="In-place XML tree mutation for Jekyll productivity" />
<meta name="author" content="Ben Swift" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I wrote a reveal.js plugin for Jekyll so that I can make nice slides (especially for my ANU courses). Recently, though, Iâ€™ve been touching up the COMP1720 slides for 2019 and itâ€™s getting really slow to build the website." />
<meta property="og:description" content="I wrote a reveal.js plugin for Jekyll so that I can make nice slides (especially for my ANU courses). Recently, though, Iâ€™ve been touching up the COMP1720 slides for 2019 and itâ€™s getting really slow to build the website." />
<link rel="canonical" href="https://benswift.me/blog/2019/07/17/in-place-xml-tree-mutation-for-jekyll-productivity/" />
<meta property="og:url" content="https://benswift.me/blog/2019/07/17/in-place-xml-tree-mutation-for-jekyll-productivity/" />
<meta property="og:site_name" content="benswift.me" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-07-17T00:00:00+10:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="In-place XML tree mutation for Jekyll productivity" />
<meta name="twitter:site" content="@benswift" />
<meta name="twitter:creator" content="@Ben Swift" />
<script type="application/ld+json">
{"url":"https://benswift.me/blog/2019/07/17/in-place-xml-tree-mutation-for-jekyll-productivity/","headline":"In-place XML tree mutation for Jekyll productivity","dateModified":"2019-07-17T00:00:00+10:00","datePublished":"2019-07-17T00:00:00+10:00","author":{"@type":"Person","name":"Ben Swift"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://benswift.me/blog/2019/07/17/in-place-xml-tree-mutation-for-jekyll-productivity/"},"description":"I wrote a reveal.js plugin for Jekyll so that I can make nice slides (especially for my ANU courses). Recently, though, Iâ€™ve been touching up the COMP1720 slides for 2019 and itâ€™s getting really slow to build the website.","@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


	<link rel="stylesheet" type="text/css" href="/assets/css/main-fa3c3362a4ed0f3517c2bba7752c287108bda00baaad52995b02fe600ff5a73d.css">
  </head>
  <body>
	<div class="container">
	  <header>

  <nav class="logo" aria-label="site home">
	<a href="/">benswift.me</a>
  </nav>

  <nav class="navigation" aria-label="main navigation">
	<!-- in-site navigation -->
	
	

	<a class="current"href="/blog/index.html">blog</a>
	<a href="/research/">research</a>
	<a href="/teaching/">teaching</a>
	<a href="/livecoding/index.html">livecoding</a>
	<a href="/talks/index.html">talks</a>
	<a href="/bio/">bio</a>

	<!-- social icons -->
	<a href="https://github.com/benswift"><i title="benswift on GitHub" class="fab fa-github"></i></a>
	<a href="https://twitter.com/benswift"><i title="benswift on twitter" class="fab fa-twitter"></i></a>
	<a href="https://vimeo.com/benswift"><i title="benswift on Vimeo" class="fab fa-vimeo"></i></a>
	<a href="https://scholar.google.com/citations?user=OQdYgLEAAAAJ"><i title="Ben's Google Scholar profile" class="fas fa-graduation-cap"></i></a>
	<a href="/feed.xml"><i title="RSS feed for this blog" class="fas fa-rss"></i></a>
	<a href="mailto:ben@benswift.me"><i title="send Ben an email" class="fas fa-envelope"></i></a>
  </nav>

</header>

	  <main aria-label="Content">
		<article>
  <p class="post-date">17 Jul '19</p>
  <h1>In-place XML tree mutation for Jekyll productivity</h1>
  
<p class="post-tag-container">
  
  <a class="post-tag" href="/blog/tag/web/">
	web
  </a>
  
</p>


  <p>I wrote a <a href="/blog/2018/09/28/another-reveal.js-plugin-for-jekyll/">reveal.js</a> plugin for Jekyll
so that I can make nice slides (especially for my
<a href="https://cs.anu.edu.au/courses/comp1720/lectures/">ANU</a>
<a href="https://cs.anu.edu.au/courses/comp2300/lectures/">courses</a>). Recently, though,
Iâ€™ve been touching up the COMP1720 slides for 2019 and itâ€™s getting <em>really
slow</em> to build the website.</p>

<p>I turned to Jekyllâ€™s built-in profiling command to see where the problem is.
Hereâ€™s the output of <code>jekyll build --profile</code> on this website, which (currently)
builds in <strong>7.2 seconds</strong> on my machine.</p>

<table>
  <thead>
    <tr>
      <th>Filename</th>
      <th>Count</th>
      <th>Bytes</th>
      <th>Time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>_layouts/reveal.html</td>
      <td>9</td>
      <td>104.60K</td>
      <td>4.102</td>
    </tr>
    <tr>
      <td>_layouts/default.html</td>
      <td>81</td>
      <td>729.15K</td>
      <td>0.809</td>
    </tr>
    <tr>
      <td>_includes/head.html</td>
      <td>90</td>
      <td>266.90K</td>
      <td>0.702</td>
    </tr>
    <tr>
      <td>research.md</td>
      <td>1</td>
      <td>16.40K</td>
      <td>0.196</td>
    </tr>
    <tr>
      <td>_includes/hljs.html</td>
      <td>90</td>
      <td>29.44K</td>
      <td>0.192</td>
    </tr>
    <tr>
      <td>_includes/slides/background-image.html</td>
      <td>9</td>
      <td>31.94K</td>
      <td>0.154</td>
    </tr>
    <tr>
      <td>_layouts/paginated.html</td>
      <td>21</td>
      <td>70.29K</td>
      <td>0.078</td>
    </tr>
    <tr>
      <td>_talks/u3a-world-since-google.md</td>
      <td>1</td>
      <td>14.49K</td>
      <td>0.058</td>
    </tr>
    <tr>
      <td>_includes/header.html</td>
      <td>81</td>
      <td>85.88K</td>
      <td>0.042</td>
    </tr>
    <tr>
      <td>_talks/ltc-stem-camp.md</td>
      <td>1</td>
      <td>13.38K</td>
      <td>0.040</td>
    </tr>
    <tr>
      <td>feed.xml</td>
      <td>1</td>
      <td>105.55K</td>
      <td>0.038</td>
    </tr>
    <tr>
      <td>â€¦more inconsequential stuff followsâ€¦</td>
      <td>Â </td>
      <td>Â </td>
      <td>Â </td>
    </tr>
  </tbody>
</table>

<p>Clearly, the <code>reveal.html</code> layout is the problem, taking 4.1s (more than half
the total build time). I suspect that this is because my <a href="/blog/2018/09/28/another-reveal.js-plugin-for-jekyll/">reveal
plugin</a> does a bunch of
copying of (Nokogiri) XML nodes, because I wasnâ€™t worrying about performance
when I wrote it.</p>

<h3 id="re-parent-all-the-nodes">Re-parent all the nodes!</h3>

<p>Looking at the <a href="https://nokogiri.org/rdoc/Nokogiri/XML/Node">Nokogiri API</a> and
the <code>revealify.rb</code> plugin code, there are a bunch of places where instead of
duplicating &amp; copying nodes, I can just re-parent them into the right places.
Iâ€™m a big immutability fan usually, which is why I built the plugin based on
copying originally, but with a bit of careful re-parenting the <code>revealify.rb</code>
plugin now looks like
<a href="https://github.com/benswift/benswift.github.io/blob/source/_plugins/revealify.rb">this</a>
(see the <a href="/blog/2018/09/28/another-reveal.js-plugin-for-jekyll/">linked post above</a> to see what it
looked like before).</p>

<p>And the result? Total build time is down to <strong>2.8 seconds</strong>. Admittedly that was
because it was <em>really inefficient</em> before, but Iâ€™ll take a 2.5x speedup anyday
ðŸ˜Š. Hereâ€™s the relevant profiler output with the updated plugin:</p>

<table>
  <thead>
    <tr>
      <th>Filename</th>
      <th>Count</th>
      <th>Bytes</th>
      <th>Time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>_layouts/default.html</td>
      <td>82</td>
      <td>741.77K</td>
      <td>0.873</td>
    </tr>
    <tr>
      <td>_includes/head.html</td>
      <td>91</td>
      <td>269.82K</td>
      <td>0.780</td>
    </tr>
    <tr>
      <td>research.md</td>
      <td>1</td>
      <td>16.40K</td>
      <td>0.198</td>
    </tr>
    <tr>
      <td>_layouts/reveal.html</td>
      <td>9</td>
      <td>105.65K</td>
      <td>0.182</td>
    </tr>
    <tr>
      <td>_includes/hljs.html</td>
      <td>91</td>
      <td>29.77K</td>
      <td>0.172</td>
    </tr>
    <tr>
      <td>_includes/slides/background-image.html</td>
      <td>9</td>
      <td>31.94K</td>
      <td>0.151</td>
    </tr>
    <tr>
      <td>_layouts/paginated.html</td>
      <td>21</td>
      <td>70.55K</td>
      <td>0.101</td>
    </tr>
    <tr>
      <td>_talks/u3a-world-since-google.md</td>
      <td>1</td>
      <td>14.50K</td>
      <td>0.058</td>
    </tr>
    <tr>
      <td>_includes/header.html</td>
      <td>82</td>
      <td>86.94K</td>
      <td>0.045</td>
    </tr>
    <tr>
      <td>_talks/ltc-stem-camp.md</td>
      <td>1</td>
      <td>13.39K</td>
      <td>0.041</td>
    </tr>
    <tr>
      <td>feed.xml</td>
      <td>1</td>
      <td>112.62K</td>
      <td>0.029</td>
    </tr>
    <tr>
      <td>â€¦more inconsequential stuff followsâ€¦</td>
      <td>Â </td>
      <td>Â </td>
      <td>Â </td>
    </tr>
  </tbody>
</table>

<p>Wow, the <code>reveal.html</code> layout has gone from 4.1s to 0.2s, a <strong>20x speedup</strong>!</p>

<p>So I guess the moral of the story is that profiling is important, and that
avoiding copies and writing filthy mutable code is helpful as long as youâ€™re
careful.</p>

<p>Now that Iâ€™ve done procrastinating with this stuff, I can get back to writing my
slides for the upcoming semester.</p>

</article>


	  </main>
	  <footer>
  <script>
   const cafeUrls = [
	 "https://biginelli.com/",
	 "http://tilleys.com.au",
	 "https://www.facebook.com/goodbrothercafe/",
	 "https://frontgallerycafe.com",
	 "https://www.facebook.com/thecoffeegrounds",
	 "https://redbrickcoffee.com.au/redbrick/"
   ];
   const randomCafe = () => {
	 window.location.href = cafeUrls[Math.floor(Math.random()*cafeUrls.length)];
   };
  </script>

  <!-- colophon -->
  <p>
	designed & built with
	<a href="https://jekyllrb.com"><i title="Jekyll homepage" class="fas fa-vial"></i></a>,
	<a id="cafe-url" onclick="randomCafe();"><i title="the website of one of Ben's favourite coffee shops" class="fas fa-coffee" style="cursor: pointer;"></i></a> and
	<a href="https://www.youtube.com/watch?v=6H2FRxvsd2M"><i title="what is love?" class="fas fa-heart"></i></a>
	by Ben Swift
  </p>

  <!-- licence -->
  <p style="font-size: 1.3em;">
	<a title="CC BY-NC-SA licence" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
  <i class="fab fa-creative-commons"></i>
  <i class="fab fa-creative-commons-by"></i>
  <i class="fab fa-creative-commons-nc"></i>
  <i class="fab fa-creative-commons-sa"></i>
</a>

  </p>

  <!-- throw shade on IE -->
  <p>
	uses <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/grid">CSS Grid</a>,
	works on all <a href="http://outdatedbrowser.com/en">modern browsers</a>
  </p>

  <!-- open source humblebrag -->
  <p>
	site revision <code>39fd3503</code>,
	<a href="https://github.com/benswift/benswift.github.io/blob/39fd3503/_posts/2019-07-17-in-place-xml-tree-mutation-for-jekyll-productivity.md">source
	available on <i title="benswift on GitHub" class="fab fa-github"></i></a>
  </p>

</footer>

	</div>
  </body>
</html>
